##############################################################################################################################
# Berserk Provinces Mechanic
##############################################################################################################################
hellfairy_add_berserk_stack = {
	if = {
		limit = {
			NOT = { has_province_flag = th_hellfairy_province_has_berserk }
		}
		add_permanent_province_modifier = {
			name = th_hellfairy_berserk_1
			duration = -1
		}
		set_province_flag = th_hellfairy_province_has_stack_1
		set_province_flag = th_hellfairy_province_has_berserk
	}
	else_if = {
		limit = {
			has_province_modifier = th_hellfairy_berserk_1
		}
		remove_province_modifier = th_hellfairy_berserk_1
		add_permanent_province_modifier = {
			name = th_hellfairy_berserk_2
			duration = -1
		}
		clr_province_flag = th_hellfairy_province_has_stack_1
		set_province_flag = th_hellfairy_province_has_stack_2
	}
	else_if = {
		limit = {
			has_province_modifier = th_hellfairy_berserk_2
		}
		remove_province_modifier = th_hellfairy_berserk_2
		add_permanent_province_modifier = {
			name = th_hellfairy_berserk_3
			duration = -1
		}
		clr_province_flag = th_hellfairy_province_has_stack_2
		set_province_flag = th_hellfairy_province_has_stack_3
	}
	else_if = {
		limit = {
			has_province_modifier = th_hellfairy_berserk_3
		}
		remove_province_modifier = th_hellfairy_berserk_3
		add_permanent_province_modifier = {
			name = th_hellfairy_berserk_4
			duration = -1
		}
		clr_province_flag = th_hellfairy_province_has_stack_3
		set_province_flag = th_hellfairy_province_has_stack_4
	}
	else_if = {
		limit = {
			has_province_modifier = th_hellfairy_berserk_4
		}
		remove_province_modifier = th_hellfairy_berserk_4
		add_permanent_province_modifier = {
			name = th_hellfairy_berserk_5
			duration = -1
		}
		clr_province_flag = th_hellfairy_province_has_stack_4
		set_province_flag = th_hellfairy_province_has_stack_5
	}
	else_if = {
		limit = {
			has_province_modifier = th_hellfairy_berserk_5
		}
		remove_province_modifier = th_hellfairy_berserk_5
		add_permanent_province_modifier = {
			name = th_hellfairy_berserk_6
			duration = -1
		}
		clr_province_flag = th_hellfairy_province_has_stack_5
		set_province_flag = th_hellfairy_province_has_stack_6
	}
	else_if = {
		limit = {
			has_province_modifier = th_hellfairy_berserk_6
		}
		remove_province_modifier = th_hellfairy_berserk_6
		add_permanent_province_modifier = {
			name = th_hellfairy_berserk_7
			duration = -1
		}
		clr_province_flag = th_hellfairy_province_has_stack_6
		set_province_flag = th_hellfairy_province_has_stack_7
	}
	else_if = {
		limit = {
			has_province_modifier = th_hellfairy_berserk_7
		}
		remove_province_modifier = th_hellfairy_berserk_7
		add_permanent_province_modifier = {
			name = th_hellfairy_berserk_8
			duration = -1
		}
		clr_province_flag = th_hellfairy_province_has_stack_7
		set_province_flag = th_hellfairy_province_has_stack_8
	}
	else_if = {
		limit = {
			has_province_modifier = th_hellfairy_berserk_8
		}
		remove_province_modifier = th_hellfairy_berserk_8
		add_permanent_province_modifier = {
			name = th_hellfairy_berserk_9
			duration = -1
		}
		clr_province_flag = th_hellfairy_province_has_stack_8
		set_province_flag = th_hellfairy_province_has_stack_9
	}
	else_if = {
		limit = {
			has_province_modifier = th_hellfairy_berserk_9
		}
		remove_province_modifier = th_hellfairy_berserk_9
		add_permanent_province_modifier = {
			name = th_hellfairy_berserk_10
			duration = -1
		}
		clr_province_flag = th_hellfairy_province_has_stack_9
		set_province_flag = th_hellfairy_province_has_stack_10
	}
}

hellfairy_inititiate_berserk_stack = {
	if = {
		limit = {
			NOT = { has_province_flag = th_hellfairy_province_has_berserk }
		}
		add_permanent_province_modifier = {
			name = th_hellfairy_berserk_4
			duration = -1
		}
		set_province_flag = th_hellfairy_province_has_stack_4
		clr_province_flag = th_hellfairy_province_has_stack_1
		clr_province_flag = th_hellfairy_province_has_stack_2
		clr_province_flag = th_hellfairy_province_has_stack_3
		clr_province_flag = th_hellfairy_province_has_stack_5
		clr_province_flag = th_hellfairy_province_has_stack_6
		clr_province_flag = th_hellfairy_province_has_stack_7
		clr_province_flag = th_hellfairy_province_has_stack_8
		clr_province_flag = th_hellfairy_province_has_stack_9
		clr_province_flag = th_hellfairy_province_has_stack_10
		remove_province_modifier = th_hellfairy_berserk_1
		remove_province_modifier = th_hellfairy_berserk_2
		remove_province_modifier = th_hellfairy_berserk_3
		remove_province_modifier = th_hellfairy_berserk_5
		remove_province_modifier = th_hellfairy_berserk_6
		remove_province_modifier = th_hellfairy_berserk_7
		remove_province_modifier = th_hellfairy_berserk_8
		remove_province_modifier = th_hellfairy_berserk_9
		remove_province_modifier = th_hellfairy_berserk_10
		set_province_flag = th_hellfairy_province_has_berserk
	}
}
 
hellfairy_remove_berserk_stack = {
	if = {
		limit = {
			has_province_modifier = th_hellfairy_berserk_1
		}
		remove_province_modifier = th_hellfairy_berserk_1
		clr_province_flag = th_hellfairy_province_has_berserk
		clr_province_flag = th_hellfairy_province_has_stack_1
	}
	else_if = {
		limit = {
			has_province_modifier = th_hellfairy_berserk_2
		}
		remove_province_modifier = th_hellfairy_berserk_2
		add_permanent_province_modifier = {
			name = th_hellfairy_berserk_1
			duration = -1
		}
		clr_province_flag = th_hellfairy_province_has_stack_2
		set_province_flag = th_hellfairy_province_has_stack_1
	}
	else_if = {
		limit = {
			has_province_modifier = th_hellfairy_berserk_3
		}
		remove_province_modifier = th_hellfairy_berserk_3
		add_permanent_province_modifier = {
			name = th_hellfairy_berserk_2
			duration = -1
		}
		clr_province_flag = th_hellfairy_province_has_stack_3
		set_province_flag = th_hellfairy_province_has_stack_2
	}
	else_if = {
		limit = {
			has_province_modifier = th_hellfairy_berserk_4
		}
		remove_province_modifier = th_hellfairy_berserk_4
		add_permanent_province_modifier = {
			name = th_hellfairy_berserk_3
			duration = -1
		}
		clr_province_flag = th_hellfairy_province_has_stack_4
		set_province_flag = th_hellfairy_province_has_stack_3
	}
	else_if = {
		limit = {
			has_province_modifier = th_hellfairy_berserk_5
		}
		remove_province_modifier = th_hellfairy_berserk_5
		add_permanent_province_modifier = {
			name = th_hellfairy_berserk_4
			duration = -1
		}
		clr_province_flag = th_hellfairy_province_has_stack_5
		set_province_flag = th_hellfairy_province_has_stack_4
	}
	else_if = {
		limit = {
			has_province_modifier = th_hellfairy_berserk_6
		}
		remove_province_modifier = th_hellfairy_berserk_6
		add_permanent_province_modifier = {
			name = th_hellfairy_berserk_5
			duration = -1
		}
		clr_province_flag = th_hellfairy_province_has_stack_6
		set_province_flag = th_hellfairy_province_has_stack_5
	}
	else_if = {
		limit = {
			has_province_modifier = th_hellfairy_berserk_7
		}
		remove_province_modifier = th_hellfairy_berserk_7
		add_permanent_province_modifier = {
			name = th_hellfairy_berserk_6
			duration = -1
		}
		clr_province_flag = th_hellfairy_province_has_stack_7
		set_province_flag = th_hellfairy_province_has_stack_6
	}
	else_if = {
		limit = {
			has_province_modifier = th_hellfairy_berserk_8
		}
		remove_province_modifier = th_hellfairy_berserk_8
		add_permanent_province_modifier = {
			name = th_hellfairy_berserk_7
			duration = -1
		}
		clr_province_flag = th_hellfairy_province_has_stack_8
		set_province_flag = th_hellfairy_province_has_stack_7
	}
	else_if = {
		limit = {
			has_province_modifier = th_hellfairy_berserk_9
		}
		remove_province_modifier = th_hellfairy_berserk_9
		add_permanent_province_modifier = {
			name = th_hellfairy_berserk_8
			duration = -1
		}
		clr_province_flag = th_hellfairy_province_has_stack_9
		set_province_flag = th_hellfairy_province_has_stack_8
	}
	else_if = {
		limit = {
			has_province_modifier = th_hellfairy_berserk_10
		}
		remove_province_modifier = th_hellfairy_berserk_10
		add_permanent_province_modifier = {
			name = th_hellfairy_berserk_9
			duration = -1
		}
		clr_province_flag = th_hellfairy_province_has_stack_10
		set_province_flag = th_hellfairy_province_has_stack_9
	}
}
 
hellfairy_remove_all_berserk_stack = {
	clr_province_flag = th_hellfairy_province_has_berserk
	remove_province_modifier = th_hellfairy_berserk_1
	remove_province_modifier = th_hellfairy_berserk_2
	remove_province_modifier = th_hellfairy_berserk_3
	remove_province_modifier = th_hellfairy_berserk_4
	remove_province_modifier = th_hellfairy_berserk_5
	remove_province_modifier = th_hellfairy_berserk_6
	remove_province_modifier = th_hellfairy_berserk_7
	remove_province_modifier = th_hellfairy_berserk_8
	remove_province_modifier = th_hellfairy_berserk_9
	remove_province_modifier = th_hellfairy_berserk_10
	clr_province_flag = th_hellfairy_province_has_stack_1
	clr_province_flag = th_hellfairy_province_has_stack_2
	clr_province_flag = th_hellfairy_province_has_stack_3
	clr_province_flag = th_hellfairy_province_has_stack_4
	clr_province_flag = th_hellfairy_province_has_stack_5
	clr_province_flag = th_hellfairy_province_has_stack_6
	clr_province_flag = th_hellfairy_province_has_stack_7
	clr_province_flag = th_hellfairy_province_has_stack_8
	clr_province_flag = th_hellfairy_province_has_stack_9
	clr_province_flag = th_hellfairy_province_has_stack_10
}

hellfairy_add_negative_berserk = {
	add_permanent_province_modifier = {
		name = th_hellfairy_negative_berserk
		duration = $days$
	}
}

##############################################################################################################################
# Copying Abilities Mechanic
##############################################################################################################################
th_clear_copy_flag = {
	clr_country_flag = th_copied_ability_of_SCR
	clr_country_flag = th_copied_ability_of_HKR
	clr_country_flag = th_copied_ability_of_FOM
	clr_country_flag = th_copied_ability_of_MHG
	clr_country_flag = th_copied_ability_of_CIN
	clr_country_flag = th_copied_ability_of_LRV
	clr_country_flag = th_copied_ability_of_TFR
	clr_country_flag = th_copied_ability_of_LIL
	clr_country_flag = th_copied_ability_of_CLP
	clr_country_flag = th_copied_ability_of_EIT
	clr_country_flag = th_copied_ability_of_FUJ
	clr_country_flag = th_copied_ability_of_NET
	clr_country_flag = th_copied_ability_of_SFF
	clr_country_flag = th_copied_ability_of_MRY
	clr_country_flag = th_copied_ability_of_CRD
	clr_country_flag = th_copied_ability_of_HIG
	clr_country_flag = th_copied_ability_of_MKI
	clr_country_flag = th_copied_ability_of_GNU
	clr_country_flag = th_copied_ability_of_FLR
	remove_country_modifier = th_copy_ability_from_NET
	remove_country_modifier = th_copy_ability_from_FUJ
	remove_country_modifier = th_copy_ability_from_SFF
	remove_country_modifier = th_copy_ability_from_HIG
	remove_country_modifier = th_copy_ability_from_MKI
	remove_country_modifier = th_copy_ability_from_GNU
	remove_country_modifier = th_copy_ability_from_FLR
	remove_country_modifier = th_copy_ability_default_fall_back
	clr_country_flag = th_copied_ability_flag
}

#The flag is @PREV so I don't have to type th_copied_ability_of_SCR, th_copied_ability_of_HKR, etc.
#Functionally, they work the same
th_copy_ability_from_target = {
	th_clear_copy_flag = yes
	set_country_flag = th_copied_ability_flag
	add_country_modifier = {
		name = th_copied_ability
		duration = $duration$
		hidden = yes
	}
	$target$ = {
		trigger_switch = {
			on_trigger = tag
			SCR = { ROOT = { set_country_flag = th_copied_ability_of_@PREV } }
			HKR = { ROOT = { set_country_flag = th_copied_ability_of_@PREV set_variable = { which = th_youkai_hunt_charges value = 1 } } }
			FOM = { ROOT = { set_country_flag = th_copied_ability_of_@PREV } }
			MHG = { ROOT = { set_country_flag = th_copied_ability_of_@PREV } }
			CIN = { ROOT = { set_country_flag = th_copied_ability_of_@PREV } }
			LRV = { ROOT = { set_country_flag = th_copied_ability_of_@PREV } }
			TFR = { ROOT = { set_country_flag = th_copied_ability_of_@PREV } }
			LIL = { ROOT = { set_country_flag = th_copied_ability_of_@PREV } }
			CLP = { ROOT = { set_country_flag = th_copied_ability_of_@PREV } }
			EIT = { ROOT = { set_country_flag = th_copied_ability_of_@PREV set_variable = { which = th_eit_aggressor_counter value = 0 } } }
			FUJ = { ROOT = { set_country_flag = th_copied_ability_of_@PREV } }
			NET = { ROOT = { set_country_flag = th_copied_ability_of_@PREV } }
			SFF = { ROOT = { set_country_flag = th_copied_ability_of_@PREV } }
			MRY = { ROOT = { set_country_flag = th_copied_ability_of_@PREV } }
			CRD = { ROOT = { set_country_flag = th_copied_ability_of_@PREV } }
			HIG = { ROOT = { set_country_flag = th_copied_ability_of_@PREV } }
			MKI = { ROOT = { set_country_flag = th_copied_ability_of_@PREV } }
			GNU = { ROOT = { set_country_flag = th_copied_ability_of_@PREV } }
			FLR = { ROOT = { set_country_flag = th_copied_ability_of_@PREV } }
		}
		if = {
			limit = {
				OR = {
					tag = FUJ
					tag = NET
					tag = SFF
					tag = HIG
					tag = MKI
					tag = GNU
					tag = FLR
				}
			}
			ROOT = {
				country_event = {
					id = th_diplo_events.39
				}
			}
		}
		if = {
			limit = {
				NOT = { tag = SCR }
				NOT = { tag = HKR }
				NOT = { tag = FOM }
				NOT = { tag = MHG }
				NOT = { tag = CIN }
				NOT = { tag = LRV }
				NOT = { tag = TFR }
				NOT = { tag = LIL }
				NOT = { tag = CLP }
				NOT = { tag = EIT }
				NOT = { tag = FUJ }
				NOT = { tag = NET }
				NOT = { tag = SFF }
				NOT = { tag = MRY }
				NOT = { tag = CRD }
				NOT = { tag = HIG }
				NOT = { tag = MKI }
				NOT = { tag = GNU }
				NOT = { tag = FLR }
			}
			ROOT = {
				add_country_modifier = {
					name = th_copy_ability_default_fall_back
					duration = $duration$
				}
			}
		}
	}
}

##############################################################################################################################
# Mokou-Kaguya Rivalry Mechanic
##############################################################################################################################
th_add_rival_estate_loyalty = {
	if = {
		limit = {
			has_estate = estate_rival_kaguya
		}
		add_estate_loyalty = {
			estate = estate_rival_kaguya
			loyalty = $loyalty$
		}
	}
	if = {
		limit = {
			has_estate = estate_rival_mokou
		}
		add_estate_loyalty = {
			estate = estate_rival_mokou
			loyalty = $loyalty$
		}
	}
}

th_add_rival_estate_influence = {
	if = {
		limit = {
			has_estate = estate_rival_kaguya
		}
		add_estate_influence_modifier = {
			estate = estate_rival_kaguya
			desc = $desc$
			influence = $influence$
			duration = $duration$
		}
	}
	if = {
		limit = {
			has_estate = estate_rival_mokou
		}
		add_estate_influence_modifier = {
			estate = estate_rival_mokou
			desc = $desc$
			influence = $influence$
			duration = $duration$
		}
	}
}

th_change_rival_estate_land_share = {
	if = {
		limit = {
			has_estate = estate_rival_kaguya
		}
		change_estate_land_share = {
			estate = estate_rival_kaguya
			share = $share$
		}
	}
	if = {
		limit = {
			has_estate = estate_rival_mokou
		}
		change_estate_land_share = {
			estate = estate_rival_mokou
			share = $share$
		}
	}
}

th_define_ruler_to_leveling_general = {
	if = {
		limit = {
			th_fuj_has_level = {
				level = 6
			}
		}
		define_ruler_to_general = {
			name = "ä…ŸS¹Y¢u"
			female = yes
			fire = 6
			shock = 5
			manuever = 5
			siege = 6
			trait = $trait$
		}
	}
	else_if = {
		limit = {
			th_fuj_has_level = {
				level = 5
			}
		}
		define_ruler_to_general = {
			name = "ä…ŸS¹Y¢u"
			female = yes
			fire = 6
			shock = 5
			manuever = 4
			siege = 6
			trait = $trait$
		}
	}
	else_if = {
		limit = {
			th_fuj_has_level = {
				level = 4
			}
		}
		define_ruler_to_general = {
			name = "ä…ŸS¹Y¢u"
			female = yes
			fire = 5
			shock = 5
			manuever = 3
			siege = 5
			trait = $trait$
		}
	}
	else_if = {
		limit = {
			th_fuj_has_level = {
				level = 3
			}
		}
		define_ruler_to_general = {
			name = "ä…ŸS¹Y¢u"
			female = yes
			fire = 5
			shock = 5
			manuever = 2
			siege = 4
			trait = $trait$
		}
	}
	else_if = {
		limit = {
			th_fuj_has_level = {
				level = 2
			}
		}
		define_ruler_to_general = {
			name = "ä…ŸS¹Y¢u"
			female = yes
			fire = 4
			shock = 4
			manuever = 2
			siege = 3
			trait = $trait$
		}
	}
	else = {
		define_ruler_to_general = {
			name = "ä…ŸS¹Y¢u"
			female = yes
			fire = 3
			shock = 3
			manuever = 2
			siege = 2
			trait = $trait$
		}
	}
	custom_tooltip = th_define_ruler_to_leveling_general_$trait$_tt
}

th_states_spawn_rival_rebels = {
	if = {
		limit = {
			owner = {
				has_reform = Gensokyan_kaguya_states_reform
			}
		}
		spawn_rebels = {
			type = nationalist_rebels
			friend = FUJ
			size = $size$
		}
	}
	else_if = {
		limit = {
			owner = {
				has_reform = Gensokyan_mokou_states_reform				
			}
		}
		spawn_rebels = {
			type = nationalist_rebels
			friend = EIT
			size = $size$
		}
	}
	spawn_rebels = {		
		type = noble_rebels
		size = $size$
	}
}

##############################################################################################################################
# Moriya Clan Faith Power Mechanic
##############################################################################################################################
#Basic add faith power effect without any scaling
mry_add_faith_power = {
	if = {
		limit = {
			mry_uses_faith_power = yes
		}
		hidden_effect = {
			set_variable = {
				which = potential_faith_power
				value = $value$
			}
			change_variable = {
				which = potential_faith_power
				which = faith_power
			}
			export_to_variable = {
				which = faith_power_limit
				value = modifier:faith_power_capacity
			}
			multiply_variable = {
				which = faith_power_limit
				value = 100
			}
		}
		if = {	#Underflow case
			limit = {
				NOT = {
					check_variable = {
						which = potential_faith_power
						value = 0
					}
				}
			}
			set_variable = {
				which = faith_power
				value = 0
			}
		}
		else_if = {	#Overflow case
			limit = {
				check_variable = {
					which = potential_faith_power
					which = faith_power_limit
				}
			}
			set_variable = {
				which = faith_power
				which = faith_power_limit
			}
		}
		else = {	#Normal case
			change_variable = {
				which = faith_power
				value = $value$
			}
		}
	}
}

#Not used yet, might come in handy later
#Adds faith power without considering your total development or religious unity
mry_add_scaled_faith_power = {
	if = {
		limit = {
			mry_uses_faith_power = yes
		}
		hidden_effect = {
			set_variable = {
				which = potential_faith_power
				value = $value$
			}
			export_to_variable = {
				which = faith_power_scaler
				value = modifier:faith_power_modifier
			}
			change_variable = {
				which = faith_power_scaler
				value = 1
			}
			if = {
				limit = {
					check_variable = {	#NO NEGATIVITY SCALER
						which = faith_power_scaler
						value = 0
					}
					check_variable = {	#NEGATIVE VALUES SHOULD NOT SCALE
						which = potential_faith_power
						value = 0
					}
				}
				multiply_variable = {
					which = potential_faith_power
					which = faith_power_scaler
				}
			}
			change_variable = {
				which = potential_faith_power
				which = faith_power
			}
			export_to_variable = {
				which = faith_power_limit
				value = modifier:faith_power_capacity
			}
			multiply_variable = {
				which = faith_power_limit
				value = 100
			}
		}
		if = {	#Underflow case
			limit = {
				NOT = {
					check_variable = {
						which = potential_faith_power
						value = 0
					}
				}
			}
			set_variable = {
				which = faith_power
				value = 0
			}
		}
		else_if = {	#Overflow case
			limit = {
				check_variable = {
					which = potential_faith_power
					which = faith_power_limit
				}
			}
			set_variable = {
				which = faith_power
				which = faith_power_limit
			}
		}
		else = {	#Normal case
			hidden_effect = {
				subtract_variable = {
					which = potential_faith_power
					which = faith_power
				}
			}
			change_variable = {
				which = faith_power
				which = potential_faith_power
			}
		}
	}
}

#Country effect
#$enforcer$ is the country, which forces the target to convert
#$converted$ is the country, which gets converted
#$value$ determines how much faith per development
#$development_factor$ multiplies the $value$ by a specified factor
mry_add_scaled_country_conversion_faith_power = {
	if = {
		limit = {
			$enforcer$ = {
				mry_uses_faith_power = yes
			}
		}
		$enforcer$ = {
			hidden_effect = {
				set_variable = {
					which = potential_faith_power
					value = $value$
				}
				export_to_variable = {
					which = faith_power_scaler
					value = modifier:faith_power_modifier
				}
				change_variable = {
					which = faith_power_scaler
					value = 1
				}
				export_to_variable = {
					which = mry_country_development
					value = total_development
					who = $converted$
				}
				multiply_variable = {
					which = mry_country_development
					value = $development_factor$
				}
				multiply_variable = {
					which = potential_faith_power
					which = mry_country_development
				}
				if = {
					limit = {
						check_variable = {	#NO NEGATIVITY SCALER
							which = faith_power_scaler
							value = 0
						}
						check_variable = {	#NEGATIVE VALUES SHOULD NOT SCALE
							which = potential_faith_power
							value = 0
						}
					}
					multiply_variable = {
						which = potential_faith_power
						which = faith_power_scaler
					}
				}
				change_variable = {
					which = potential_faith_power
					which = faith_power
				}
				export_to_variable = {
					which = faith_power_limit
					value = modifier:faith_power_capacity
				}
				multiply_variable = {
					which = faith_power_limit
					value = 100
				}
			}
			if = {	#Underflow case
				limit = {
					NOT = {
						check_variable = {
							which = potential_faith_power
							value = 0
						}
					}
				}
				set_variable = {
					which = faith_power
					value = 0
				}
			}
			else_if = {	#Overflow case
				limit = {
					check_variable = {
						which = potential_faith_power
						which = faith_power_limit
					}
				}
				set_variable = {
					which = faith_power
					which = faith_power_limit
				}
			}
			else = {	#Normal case
				hidden_effect = {
					subtract_variable = {
						which = potential_faith_power
						which = faith_power
					}
				}
				change_variable = {
					which = faith_power
					which = potential_faith_power
				}
			}
		}
	}
}

#Province effect
#$value$ determines how much faith per development
#$development_factor$ multiplies the $value$ by a specified factor
mry_add_scaled_province_conversion_faith_power = {
	if = {
		limit = {
			owner = {
				mry_uses_faith_power = yes
			}
		}
		owner = {
			hidden_effect = {
				set_variable = {
					which = potential_faith_power
					value = $value$
				}
				export_to_variable = {
					which = faith_power_scaler
					value = modifier:faith_power_modifier
				}
				change_variable = {
					which = faith_power_scaler
					value = 1
				}
				export_to_variable = {
					which = mry_province_development
					value = development
					who = ROOT
				}
				multiply_variable = {
					which = mry_province_development
					value = $development_factor$
				}
				multiply_variable = {
					which = potential_faith_power
					which = mry_province_development
				}
				if = {
					limit = {
						check_variable = {	#NO NEGATIVITY SCALER
							which = faith_power_scaler
							value = 0
						}
						check_variable = {	#NEGATIVE VALUES SHOULD NOT SCALE
							which = potential_faith_power
							value = 0
						}
					}
					multiply_variable = {
						which = potential_faith_power
						which = faith_power_scaler
					}
				}
				change_variable = {
					which = potential_faith_power
					which = faith_power
				}
				export_to_variable = {
					which = faith_power_limit
					value = modifier:faith_power_capacity
				}
				multiply_variable = {
					which = faith_power_limit
					value = 100
				}
			}
			if = {	#Underflow case
				limit = {
					NOT = {
						check_variable = {
							which = potential_faith_power
							value = 0
						}
					}
				}
				set_variable = {
					which = faith_power
					value = 0
				}
			}
			else_if = {	#Overflow case
				limit = {
					check_variable = {
						which = potential_faith_power
						which = faith_power_limit
					}
				}
				set_variable = {
					which = faith_power
					which = faith_power_limit
				}
			}
			else = {	#Normal case				
				hidden_effect = {
					subtract_variable = {
						which = potential_faith_power
						which = faith_power
					}
				}
				change_variable = {
					which = faith_power
					which = potential_faith_power
				}
			}
		}
	}
}

#This effect is the base faith power you get. This gets applied always first
#In the event, the base monthly faith power is 1
mry_add_base_scaled_faith_power = {
	export_to_variable = {
		which = base_faith_power_gain
		value = $value$
		who = ROOT
	}
	export_to_variable = {
		which = faith_power_scaler
		value = modifier:faith_power_modifier
	}
	change_variable = {
		which = faith_power_scaler
		value = 1
	}
	#Factors for gaining faith power
	#+ 1/1000 of your total development as faith power
	export_to_variable = {
		which = faith_power_development
		value = total_development
	}
	divide_variable = {
		which = faith_power_development
		value = 1000
	}
	#The faith power you get is multiplied with your religious unity - 100% means you get the full faith power (*1)
	export_to_variable = {
		which = faith_power_religious_unity
		value = religious_unity
	}
	export_to_variable = {
		variable_name = th_additional_faith_power
		value = modifier:monthly_faith_power
		who = ROOT
	}
	change_variable = {
		which = th_additional_faith_power
		which = base_faith_power_gain
	}
	change_variable = {
		which = th_additional_faith_power
		which = faith_power_development
	}
	multiply_variable = {
		which = th_additional_faith_power
		which = faith_power_religious_unity
	}
	#Then the faith power you gain will be multiplied with modifiers for scaling
	if = {
		limit = {
			check_variable = {	#NO NEGATIVITY SCALER
				which = faith_power_scaler
				value = 0
			}
			check_variable = {	#NEGATIVE VALUES SHOULD NOT SCALE
				which = th_additional_faith_power
				value = 0
			}
		}
		multiply_variable = {
			which = th_additional_faith_power
			which = faith_power_scaler
		}
	}
	change_variable = {
		which = th_additional_faith_power
		which = faith_power
	}
	#The faith power you would get will now tested if it causes an overflow, underflow or if it is okay
	export_to_variable = {
		which = faith_power_limit
		value = modifier:faith_power_capacity
	}
	multiply_variable = {
		which = faith_power_limit
		value = 100
	}
	if = {	#Underflow case
		limit = {
			NOT = {
				check_variable = {
					which = th_additional_faith_power
					value = 0
				}
			}
		}
		set_variable = {
			which = faith_power
			value = 0
		}
	}
	else_if = {	#Overflow case
		limit = {
			check_variable = {
				which = th_additional_faith_power
				which = faith_power_limit
			}
		}
		set_variable = {
			which = faith_power
			which = faith_power_limit
		}
	}
	else = {	#Normal case				
		hidden_effect = {
			subtract_variable = {
				which = th_additional_faith_power
				which = faith_power
			}
		}
		change_variable = {
			which = faith_power
			which = th_additional_faith_power
		}
	}
}

mry_increase_miracle_counter = {
	hidden_effect = {
		change_variable = {
			which = mry_miracle_counter
			value = 1
		}
	}
}

##############################################################################################################################
# Royal Fairy Challenge Mechanic
##############################################################################################################################
th_rfc_initiate_challenge = {
	custom_tooltip = th_rfc_initiate_challenge_tt
	hidden_effect = {
		set_global_flag = th_royal_fairy_challenge_happened_once
		set_global_flag = th_royal_fairy_challenge_has_begun
		set_country_flag = th_participates_royal_fairy_challenge
		set_country_flag = th_rfc_has_variables_set
		if = {
			limit = {
				NOT = {
					calc_true_if = {
						all_country = {
							ai = no
							primary_culture = Fairy
						}
						amount = 2
					}
				}
			}
			set_global_flag = th_royal_fairy_challenge_singleplayer
		}
		clr_global_flag = th_royal_fairy_challenge_is_about_to_happen
		set_variable = {
			which = th_royal_fairy_challenge_points
			value = 0
		}
		set_variable = {
			which = th_rfc_own_high_score
			value = 0
		}
		#Variable for checking of how long RFC is going
		1 = {	#Happens in Stockholm because we don't have a global variable
			set_province_flag = th_rfc_start_cooldown
			set_variable = {
				which = th_rfc_current_cycle_of_challenge
				value = 0
			}
		}
		if = {
			limit = { th_rfc_is_singleplayer = no }
			#Sending invites to the other fairies
			every_country = {
				limit = {
					primary_culture = Fairy
					is_colonial_nation = no
					is_client_nation = no
					NOT = { tag = ROOT }
				}
				country_event = {
					id = rfc_events.1
				}
			}
		}
		else = {
			set_variable = {	#How many points a fairy nation should get to win
				which = th_rfc_goal_points
				value = 25
			}
		}
		#Explaning event of what is going on
		country_event = {
			id = rfc_events.2
		}
	}
}

th_rfc_select_the_bakas = {
	random_country = {
		limit = {
			capital_scope = {
				continent = gensokyo_continent
			}
			NOT = { has_country_flag = th_participates_royal_fairy_challenge }
		}
		set_country_flag = th_rfc_baka_for_diplomacy_of_@ROOT
	}
	random_country = {
		limit = {
			capital_scope = {
				continent = gensokyo_continent
			}
			NOT = { has_country_flag = th_participates_royal_fairy_challenge }
			NOT = { has_country_flag = th_rfc_baka_for_diplomacy_of_@ROOT }
			NOT = { alliance_with = ROOT }
			NOT = { is_subject_of = ROOT }
		}
		set_country_flag = th_rfc_baka_for_warfare_of_@ROOT
		reverse_add_casus_belli = {
			type = cb_touhou_baka_war
			target = ROOT
		}
	}
	random_country = {
		limit = {
			capital_scope = {
				continent = gensokyo_continent
			}
			NOT = { has_country_flag = th_participates_royal_fairy_challenge }
			NOT = { has_country_flag = th_rfc_baka_for_diplomacy_of_@ROOT }
			NOT = { has_country_flag = th_rfc_baka_for_warfare_of_@ROOT }
			NOT = { is_rival = ROOT }
			ROOT = {
				NOT = { is_rival = PREV }
			}
		}
		set_country_flag = th_rfc_baka_for_royalty_of_@ROOT
	}
	random_country = {
		limit = {
			capital_scope = {
				continent = gensokyo_continent
			}
			NOT = { has_country_flag = th_participates_royal_fairy_challenge }
			NOT = { has_country_flag = th_rfc_baka_for_diplomacy_of_@ROOT }
			NOT = { has_country_flag = th_rfc_baka_for_warfare_of_@ROOT }
			NOT = { has_country_flag = th_rfc_baka_for_royalty_of_@ROOT }
			is_free_or_tributary_trigger = yes
			NOT = { alliance_with = ROOT }
			NOT = { is_subject_of = ROOT }
		}
		set_country_flag = th_rfc_baka_for_duel_of_@ROOT
		#Reset Danmaku Flags so the fairy can immediately challenge
		clr_country_flag = th_was_already_danmaku_challenged_by_@ROOT
		clr_country_flag = th_danmaku_duel_lost_against_@FROM
	}
	random_country = {
		limit = {
			capital_scope = {
				continent = gensokyo_continent
			}
			NOT = { has_country_flag = th_participates_royal_fairy_challenge }
			NOT = { has_country_flag = th_rfc_baka_for_diplomacy_of_@ROOT }
			NOT = { has_country_flag = th_rfc_baka_for_warfare_of_@ROOT }
			NOT = { has_country_flag = th_rfc_baka_for_royalty_of_@ROOT }
			NOT = { has_country_flag = th_rfc_baka_for_duel_of_@ROOT }
			NOT = { alliance_with = ROOT }
			NOT = { is_subject_of = ROOT }
		}
		set_country_flag = th_rfc_baka_for_pranks_of_@ROOT
		#Reset Prank flags
		clr_country_flag = th_was_pranked_by_@ROOT
	}
}

th_rfc_show_the_bakas = {
	random_country = {
		limit = {
			has_country_flag = th_rfc_baka_for_diplomacy_of_@ROOT
		}
		custom_tooltip = th_rfc_is_baka_for_diplomacy_challenge
	}
	random_country = {
		limit = {
			has_country_flag = th_rfc_baka_for_warfare_of_@ROOT
		}
		custom_tooltip = th_rfc_is_baka_for_warfare_challenge
	}
	random_country = {
		limit = {
			has_country_flag = th_rfc_baka_for_royalty_of_@ROOT
		}
		custom_tooltip = th_rfc_is_baka_for_royalty_challenge
	}
	random_country = {
		limit = {
			has_country_flag = th_rfc_baka_for_duel_of_@ROOT
		}
		custom_tooltip = th_rfc_is_baka_for_duel_challenge
	}
	random_country = {
		limit = {
			has_country_flag = th_rfc_baka_for_pranks_of_@ROOT
		}
		custom_tooltip = th_rfc_is_baka_for_pranks_challenge
	}
}

th_rfc_show_the_scores = {
	custom_tooltip = th_rfc_own_score_tt
	custom_tooltip = th_rfc_gets_scores_from_other_participants_tt
	hidden_effect = {
		every_country = {
			limit = {
				has_country_flag = th_participates_royal_fairy_challenge
				NOT = { tag = ROOT }
			}
			country_event = {
				id = rfc_events.13
			}
		}
	}
}

th_rfc_clean_the_bakas = {
	every_country = {
		limit = {
			has_country_flag = th_participates_royal_fairy_challenge
		}
		every_country = {
			limit = {
				OR = {
					has_country_flag = th_rfc_baka_for_diplomacy_of_@ROOT
					has_country_flag = th_rfc_baka_for_warfare_of_@ROOT
					has_country_flag = th_rfc_baka_for_royalty_of_@ROOT
					has_country_flag = th_rfc_baka_for_duel_of_@ROOT
					has_country_flag = th_rfc_baka_for_pranks_of_@ROOT
				}
			}
			clr_country_flag = th_rfc_baka_for_diplomacy_of_@ROOT
			clr_country_flag = th_rfc_baka_for_warfare_of_@ROOT
			clr_country_flag = th_rfc_baka_for_royalty_of_@ROOT
			clr_country_flag = th_rfc_baka_for_duel_of_@ROOT
			clr_country_flag = th_rfc_baka_for_pranks_of_@ROOT
		}
	}
}

th_rfc_fairies_get_the_baka_event = {
	every_country = {
		limit = {
			has_country_flag = th_participates_royal_fairy_challenge
		}
		country_event = {
			id = rfc_events.4
		}
	}
}

th_rfc_absolve_a_challenge = {
	every_country = {
		limit = {
			has_country_flag = th_rfc_baka_for_$type$_of_@ROOT
		}
		clr_country_flag = th_rfc_baka_for_$type$_of_@ROOT
	}
	change_variable = {
		which = th_royal_fairy_challenge_points
		value = $value$
	}
	change_variable = {
		which = th_rfc_own_high_score
		value = $value$
	}	
}

##############################################################################################################################
# Satori Vassals Mechanic
##############################################################################################################################
#Update slot tracker for overlord
th_satori_vassal_update_slot_tracker = {
	#Update the Slot Tracker
	export_to_variable = {
		which = th_diplo_slot_tracker
		value = modifier:vassal_upkeep
		who = ROOT
	}
	if = {
		limit = {
			NOT = { num_of_subjects = 1 }
		}
		set_variable = {
			which = th_subject_tracker
			value = 0
		}
	}
	else = {
		set_variable = {
			which = th_subject_counter
			value = 0
		}
		every_subject_country = {
			limit = {
				is_subject_of_type = th_satori_vassal
			}
			overlord = {
				change_variable = {
					which = th_subject_counter
					value = 1
				}
			}
		}
		set_variable = {
			which = th_subject_tracker
			which = th_subject_counter
		}
	}
	set_variable = {
		which = th_subjects_over_limit
		which = th_subject_tracker
	}
	subtract_variable = {
		which = th_subjects_over_limit
		which = th_diplo_slot_tracker
	}
}

#Add scaling liberty desire to subject
#Root is in that case the overlord
th_satori_vassal_add_liberty_desire = {
	if = {	#Subjects become independent!
		limit = {
			ROOT = {
				check_variable = {
					which = th_subjects_over_limit
					value = 9
				}
			}
		}
		custom_tooltip = th_satori_vassal_add_liberty_desire_independence_tt
		hidden_effect = {
			ROOT = {
				country_event = {
					id = th_satori_vassal_mechanic.12
				}
			}
		}
	}
	else_if = {
		limit = {
			ROOT = {
				check_variable = {
					which = th_subjects_over_limit
					value = 8
				}
			}
		}
		add_country_modifier = {
			name = th_desire_for_freedom_8
			duration = -1
		}
		hidden_effect = {
			remove_country_modifier = th_desire_for_freedom_1
			remove_country_modifier = th_desire_for_freedom_2
			remove_country_modifier = th_desire_for_freedom_3
			remove_country_modifier = th_desire_for_freedom_4
			remove_country_modifier = th_desire_for_freedom_5
			remove_country_modifier = th_desire_for_freedom_6
			remove_country_modifier = th_desire_for_freedom_7
		}
	}
	else_if = {
		limit = {
			ROOT = {
				check_variable = {
					which = th_subjects_over_limit
					value = 7
				}
			}
		}
		add_country_modifier = {
			name = th_desire_for_freedom_7
			duration = -1
		}
		hidden_effect = {
			remove_country_modifier = th_desire_for_freedom_1
			remove_country_modifier = th_desire_for_freedom_2
			remove_country_modifier = th_desire_for_freedom_3
			remove_country_modifier = th_desire_for_freedom_4
			remove_country_modifier = th_desire_for_freedom_5
			remove_country_modifier = th_desire_for_freedom_6
			remove_country_modifier = th_desire_for_freedom_8
		}
	}
	else_if = {
		limit = {
			ROOT = {
				check_variable = {
					which = th_subjects_over_limit
					value = 6
				}
			}
		}
		add_country_modifier = {
			name = th_desire_for_freedom_6
			duration = -1
		}
		hidden_effect = {
			remove_country_modifier = th_desire_for_freedom_1
			remove_country_modifier = th_desire_for_freedom_2
			remove_country_modifier = th_desire_for_freedom_3
			remove_country_modifier = th_desire_for_freedom_4
			remove_country_modifier = th_desire_for_freedom_5
			remove_country_modifier = th_desire_for_freedom_7
			remove_country_modifier = th_desire_for_freedom_8
		}
	}
	else_if = {
		limit = {
			ROOT = {
				check_variable = {
					which = th_subjects_over_limit
					value = 5
				}
			}
		}
		add_country_modifier = {
			name = th_desire_for_freedom_5
			duration = -1
		}
		hidden_effect = {
			remove_country_modifier = th_desire_for_freedom_1
			remove_country_modifier = th_desire_for_freedom_2
			remove_country_modifier = th_desire_for_freedom_3
			remove_country_modifier = th_desire_for_freedom_4
			remove_country_modifier = th_desire_for_freedom_6
			remove_country_modifier = th_desire_for_freedom_7
			remove_country_modifier = th_desire_for_freedom_8
		}
	}
	else_if = {
		limit = {
			ROOT = {
				check_variable = {
					which = th_subjects_over_limit
					value = 4
				}
			}
		}
		add_country_modifier = {
			name = th_desire_for_freedom_4
			duration = -1
		}
		hidden_effect = {
			remove_country_modifier = th_desire_for_freedom_1
			remove_country_modifier = th_desire_for_freedom_2
			remove_country_modifier = th_desire_for_freedom_3
			remove_country_modifier = th_desire_for_freedom_5
			remove_country_modifier = th_desire_for_freedom_6
			remove_country_modifier = th_desire_for_freedom_7
			remove_country_modifier = th_desire_for_freedom_8
		}
	}
	else_if = {
		limit = {
			ROOT = {
				check_variable = {
					which = th_subjects_over_limit
					value = 3
				}
			}
		}
		add_country_modifier = {
			name = th_desire_for_freedom_3
			duration = -1
		}
		hidden_effect = {
			remove_country_modifier = th_desire_for_freedom_1
			remove_country_modifier = th_desire_for_freedom_2
			remove_country_modifier = th_desire_for_freedom_4
			remove_country_modifier = th_desire_for_freedom_5
			remove_country_modifier = th_desire_for_freedom_6
			remove_country_modifier = th_desire_for_freedom_7
			remove_country_modifier = th_desire_for_freedom_8
		}
	}
	else_if = {
		limit = {
			ROOT = {
				check_variable = {
					which = th_subjects_over_limit
					value = 2
				}
			}
		}
		add_country_modifier = {
			name = th_desire_for_freedom_2
			duration = -1
		}
		hidden_effect = {
			remove_country_modifier = th_desire_for_freedom_1
			remove_country_modifier = th_desire_for_freedom_3
			remove_country_modifier = th_desire_for_freedom_4
			remove_country_modifier = th_desire_for_freedom_5
			remove_country_modifier = th_desire_for_freedom_6
			remove_country_modifier = th_desire_for_freedom_7
			remove_country_modifier = th_desire_for_freedom_8
		}
	}
	else_if = {
		limit = {
			ROOT = {
				check_variable = {
					which = th_subjects_over_limit
					value = 1
				}
			}
		}
		add_country_modifier = {
			name = th_desire_for_freedom_1
			duration = -1
		}
		hidden_effect = {
			remove_country_modifier = th_desire_for_freedom_2
			remove_country_modifier = th_desire_for_freedom_3
			remove_country_modifier = th_desire_for_freedom_4
			remove_country_modifier = th_desire_for_freedom_5
			remove_country_modifier = th_desire_for_freedom_6
			remove_country_modifier = th_desire_for_freedom_7
			remove_country_modifier = th_desire_for_freedom_8
		}
	}
	else = {
		th_satori_vassal_remove_all_liberty_desire = yes
	}
}

#Remove scaling liberty desire to subject
th_satori_vassal_remove_all_liberty_desire = {
	remove_country_modifier = th_desire_for_freedom_1
	remove_country_modifier = th_desire_for_freedom_2
	remove_country_modifier = th_desire_for_freedom_3
	remove_country_modifier = th_desire_for_freedom_4
	remove_country_modifier = th_desire_for_freedom_5
	remove_country_modifier = th_desire_for_freedom_6
	remove_country_modifier = th_desire_for_freedom_7
	remove_country_modifier = th_desire_for_freedom_8
}

th_satori_clean_up_all_modifiers = {
	th_satori_vassal_remove_all_liberty_desire = yes
	remove_country_modifier = th_admin_support
	remove_country_modifier = th_satoris_command
	remove_country_modifier = th_false_memory_cd
	remove_country_modifier = th_influencing_vassal
	remove_country_modifier = th_hellish_officers
}

##############################################################################################################################
# Yama Mechanic
##############################################################################################################################
th_yama_force_unlawful_territory_back = {
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			development = 10
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			development = 20
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			development = 30
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			development = 40
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			development = 50
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			development = 60
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			development = 70
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			development = 80
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			development = 90
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			development = 100
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = yes
			}
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = yes
			}
			development = 10
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = yes
			}
			development = 20
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = yes
			}
			development = 30
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = yes
			}
			development = 40
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = yes
			}
			development = 50
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = yes
			}
			development = 60
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = yes
			}
			development = 70
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = yes
			}
			development = 80
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = yes
			}
			development = 90
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = yes
			}
			development = 100
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = no
			}
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = no
			}
			development = 10
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = no
			}
			development = 20
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = no
			}
			development = 30
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = no
			}
			development = 40
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = no
			}
			development = 50
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = no
			}
			development = 60
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = no
			}
			development = 70
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = no
			}
			development = 80
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = no
			}
			development = 90
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = no
			}
			development = 100
		}
		save_event_target_as = th_unlawful_territory
	}
	event_target:th_unlawful_territory = {
		owner = { save_event_target_as = th_previous_owner }
		random_core_country = {
			save_event_target_as = th_new_owner
			event_target:th_unlawful_territory = {
				cede_province = PREV
			}
			add_opinion = {
				who = ROOT
				modifier = th_returned_our_core
			}
		}
		[[improved_effect]
			ROOT = {
				export_to_variable = {
					which = from_total_dev
					value = development
					who = PREV
				}
				country_event = {
					id = th_yama_authority_event.89
				}
			}
		]
	}
	if = {
		limit = {
			event_target:th_new_owner = {
				NOT = { num_of_cities = 2 }
			}
		}
		event_target:th_previous_owner = {
			add_truce_with = event_target:th_new_owner
		}
	}
}

th_yama_force_partition = {
	every_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			any_core_country = {
				is_core = PREV
			}
		}
		random_core_country = {
			limit = {
				NOT = { tag = ROOT }
			}
			PREV = { cede_province = PREV }
			add_opinion = {
				who = ROOT
				modifier = th_returned_our_core
			}
		}
	}
	#while = {
	#	limit = {
	#		any_owned_province = {
	#			continent = gensokyo_continent
	#			is_capital = no
	#			any_core_country = {
	#				OR = {
	#					exists = no
	#					has_country_flag = th_relaesed_from_partition_by_@FROM
	#				}
	#				is_core = PREV
	#			}
	#		}
	#	}
	#	random_owned_province = {
	#		limit = {
	#			continent = gensokyo_continent
	#			is_capital = no
	#			any_core_country = {
	#				OR = {
	#					exists = no
	#					has_country_flag = th_relaesed_from_partition_by_@FROM
	#				}
	#				is_core = PREV
	#			}
	#		}
	#		random_core_country = {
	#			PREV = {
	#				cede_province = PREV
	#			}
	#			if = {
	#				limit = { NOT = { has_country_flag = th_relaesed_from_partition_by_@FROM } }
	#				set_country_flag = th_relaesed_from_partition_by_@FROM
	#			}
	#		}
	#	}
	#}
	#every_country = {
	#	limit = { has_country_flag = th_relaesed_from_partition_by_@FROM }
	#	clr_country_flag = th_relaesed_from_partition_by_@FROM
	#}
}

th_yama_refuse_unlawful_territory_back = {
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			development = 10
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			development = 20
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			development = 30
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			development = 40
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = yes
			}
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = yes
			}
			development = 10
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = yes
			}
			development = 20
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = yes
			}
			development = 30
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = yes
			}
			development = 40
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = no
			}
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = no
			}
			development = 10
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = no
			}
			development = 20
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = no
			}
			development = 30
		}
		save_event_target_as = th_unlawful_territory
	}
	random_owned_province = {
		limit = {
			continent = gensokyo_continent
			is_capital = no
			NOT = { has_province_modifier = th_unlawful_territory }
			NOT = { is_core = FROM }
			any_core_country = {
				exists = no
			}
			development = 40
		}
		save_event_target_as = th_unlawful_territory
	}
	event_target:th_unlawful_territory = {
		add_province_modifier = {
			name = th_unlawful_territory
			duration = 3650
		}
	}
}

th_yama_lecture_effect = {
	custom_tooltip = th_yama_lecture_effect_tt
	hidden_effect = {
		clr_country_flag = th_recently_lectured
		set_country_flag = th_recently_lectured
		country_event = {
			id = th_yama_authority_event.98
		}
	}
}

th_return_gensokyan_provinces = {
	custom_tooltip = th_return_gensokyan_provinces_tt
	hidden_effect = {
		while = {
			limit = {
				any_owned_province = {
					NOT = { has_province_flag = th_province_to_give_back_from_@ROOT }
					NOT = { has_province_flag = th_province_to_release_from_@ROOT }
					continent = gensokyo_continent
					NOT = { region = former_hell_region }
					NOT = { region = hell_region }
					NOT = { region = netherworld_region }
					NOT = { area = Konngaras_state }
					any_core_country = {
						NOT = { tag = ROOT }
						exists = no
					}
				}
			}
			random_owned_province = {
				limit = {
					NOT = { has_province_flag = th_province_to_give_back_from_@ROOT }
					NOT = { has_province_flag = th_province_to_release_from_@ROOT }
					continent = gensokyo_continent
					NOT = { region = former_hell_region }
					NOT = { region = hell_region }
					NOT = { region = netherworld_region }
					NOT = { area = Konngaras_state }
					any_core_country = {
						NOT = { tag = ROOT }
						exists = no
					}
				}
				set_province_flag = th_province_to_release_from_@ROOT
			}
		}
		while = {
			limit = {
				any_owned_province = {
					NOT = { has_province_flag = th_province_to_give_back_from_@ROOT }
					NOT = { has_province_flag = th_province_to_release_from_@ROOT }
					NOT = { province_id = event_target:mhg_province_to_give }
					continent = gensokyo_continent
					NOT = { region = former_hell_region }
					NOT = { region = hell_region }
					NOT = { region = netherworld_region }
					NOT = { area = Konngaras_state }
					any_core_country = {
						NOT = { tag = ROOT }
						exists = yes
					}
				}
			}
			random_owned_province = {
				limit = {
					NOT = { has_province_flag = th_province_to_give_back_from_@ROOT }
					NOT = { has_province_flag = th_province_to_release_from_@ROOT }
					NOT = { province_id = event_target:mhg_province_to_give }
					continent = gensokyo_continent
					NOT = { region = former_hell_region }
					NOT = { region = hell_region }
					NOT = { region = netherworld_region }
					NOT = { area = Konngaras_state }
					any_core_country = {
						NOT = { tag = ROOT }
						exists = yes
					}
				}
				set_province_flag = th_province_to_give_back_from_@ROOT
			}
		}
		every_owned_province = {
			limit = { 
				has_province_flag = th_province_to_release_from_@ROOT
			}
			random_core_country = {
				limit = {
					NOT = { tag = ROOT }
				}
				PREV = {
					cede_province = PREV
					remove_core = ROOT
				}
			}
			clr_province_flag = th_province_to_release_from_@ROOT
			ROOT = { add_liberty_desire = 2 }
		}
		every_owned_province = {
			limit = { 
				has_province_flag = th_province_to_give_back_from_@ROOT
			}
			random_core_country = {
				limit = {
					NOT = { tag = ROOT }
					exists = yes
				}
				PREV = {
					cede_province = PREV
					remove_core = ROOT
				}
			}
			clr_province_flag = th_province_to_give_back_from_@ROOT
			ROOT = { add_liberty_desire = 2 }
		}
		every_owned_province = {
			limit = {
				OR = {
					area = Eientei_state
					area = Bamboo_forest_of_the_lost
				}
			}
			add_core = EIT
			cede_province = EIT
		}
		every_owned_province = {
			limit = { area = Fujiwara_state }
			add_core = FUJ
			cede_province = FUJ
		}
	}
}

##############################################################################################################################
# Fairy Election Mechanic
##############################################################################################################################
th_show_random_candidate_bonus = {
	if = {
		limit = {
			has_global_modifier_value = {
				which = candidate_random_bonus
				value = 1
			}
		}
		custom_tooltip = th_lottery_candidate_bonus_one
	}
}

th_show_random_candidate_bonus_plural = {
	if = {
		limit = {
			has_global_modifier_value = {
				which = candidate_random_bonus
				value = 1
			}
		}
		custom_tooltip = th_lottery_candidate_bonus_plural
	}
}

###MHG MERC STUFF###
th_mhg_mark_march_as_special_case = {
	custom_tooltip = th_mhg_mark_march_as_special_case_tt
	hidden_effect = {
		set_country_flag = mhg_is_special_case_march
	}
}

##############################################################################################################################
# Netherworld Cuisine Mechanic
##############################################################################################################################
#Can unlock following cuisines: 
#mediterranean
#west_european
#middle_european
#muslim
#east_african
#west_african
#southeast_asian
#far_east
#indian
net_unlock_cuisine = {
	[[cuisine]
		custom_tooltip = net_unlock_$cuisine$_cuisine_tt
		hidden_effect = {
			set_country_flag = net_unlocked_$cuisine$_cuisine
			change_variable = {
				which = net_unlocked_cuisines
				value = 1
			}
		}
	]
}

net_activate_cuisine_buff = {
	[[cuisine]
		hidden_effect = {
			change_variable = {
				which = net_active_cuisine_counter
				value = 1
			}
			set_country_flag = net_$cuisine$_cuisine_active
		}
		add_country_modifier = {
			name = net_$cuisine$_cuisine_modifier
			duration = $duration$
		}
	]
}

net_remove_cuisine_flag = {
	[[cuisine]
		hidden_effect = {
			clr_country_flag = net_$cuisine$_cuisine_active
			subtract_variable = {
				which = net_active_cuisine_counter
				value = 1
			}
		}
	]
}

net_pay_cuisine_fee = {
	if = {
		limit = {
			NOT = {
				check_variable = {
					which = net_active_cuisine_counter
					value = 1
				}
			}
		}
		add_years_of_income = -1
	}
	if = {
		limit = {
			check_variable = {
				which = net_active_cuisine_counter
				value = 1
			}
			NOT = {
				check_variable = {
					which = net_active_cuisine_counter
					value = 2
				}
			}
		}
		add_years_of_income = -3
	}
	if = {
		limit = {
			check_variable = {
				which = net_active_cuisine_counter
				value = 2
			}
			NOT = {
				check_variable = {
					which = net_active_cuisine_counter
					value = 3
				}
			}
		}
		add_years_of_income = -5
	}
	if = {
		limit = {
			check_variable = {
				which = net_active_cuisine_counter
				value = 3
			}
			NOT = {
				check_variable = {
					which = net_active_cuisine_counter
					value = 4
				}
			}
		}
		add_years_of_income = -7
	}
	if = {
		limit = {
			check_variable = {
				which = net_active_cuisine_counter
				value = 4
			}
			NOT = {
				check_variable = {
					which = net_active_cuisine_counter
					value = 5
				}
			}
		}
		add_years_of_income = -9
	}
	if = {
		limit = {
			check_variable = {
				which = net_active_cuisine_counter
				value = 5
			}
			NOT = {
				check_variable = {
					which = net_active_cuisine_counter
					value = 6
				}
			}
		}
		add_years_of_income = -11
	}
	if = {
		limit = {
			check_variable = {
				which = net_active_cuisine_counter
				value = 6
			}
			NOT = {
				check_variable = {
					which = net_active_cuisine_counter
					value = 7
				}
			}
		}
		add_years_of_income = -13
	}
	if = {
		limit = {
			check_variable = {
				which = net_active_cuisine_counter
				value = 7
			}
			NOT = {
				check_variable = {
					which = net_active_cuisine_counter
					value = 8
				}
			}
		}
		add_years_of_income = -15
	}
	if = {
		limit = {
			check_variable = {
				which = net_active_cuisine_counter
				value = 8
			}
		}
		add_years_of_income = -17
	}
}

##############################################################################################################################
# Lawgiver Mechanic
##############################################################################################################################
th_enable_legal_code_for_gensokyo = {
	custom_tooltip = th_enable_legal_code_for_gensokyo_tt
	hidden_effect = {
		set_global_flag = th_gensokyan_code_enabled
		#Deprecated for now, script is kept for future Senkai update
		#save_global_event_target_as = LawgiverOfGensokyo
		#1 = {
		#	set_variable = {
		#		which = th_gensokyan_law_debate_pro
		#		value = 0
		#	}
		#	set_variable = {
		#		which = th_gensokyan_law_debate_con
		#		value = 0
		#	}
		#}
	}
	#event_target:LawgiverOfGensokyo = {
		add_country_modifier = {
			name = th_lawgiver_of_gensokyo
			duration = -1
		}
	#}
}

th_disable_legal_code_for_gensokyo = {
	custom_tooltip = th_disable_legal_code_for_gensokyo_tt
	hidden_effect = {
		#Deprecated for now, script is kept for future Senkai update
		#if = {
		#	limit = {
		#		has_global_flag = th_gensokyan_code_enabled
		#	}
		#	1 = {
		#		set_variable = {
		#			which = th_gensokyan_law_debate_pro
		#			value = 0
		#		}
		#		set_variable = {
		#			which = th_gensokyan_law_debate_con
		#			value = 0
		#		}
		#	}
			clr_global_flag = th_gensokyan_code_enabled
		#}
		#clear_global_event_target = LawgiverOfGensokyo
		every_country = {
			limit = {
				has_country_modifier = th_lawgiver_of_gensokyo
			}
			remove_country_modifier = th_lawgiver_of_gensokyo
		}
	}
}

th_invest_into_gensokyan_decree = {
	gensokyo_continent = {
		hidden_effect = {
			remove_province_modifier = th_local_yama_support
			remove_province_modifier = th_local_shrine_support
			remove_province_modifier = th_local_artisan_support
			remove_province_modifier = th_local_scholar_support
			remove_province_modifier = th_local_youkai_support
		}
		add_permanent_province_modifier = {
			name = th_local_$decree$_support
			duration = 7300
		}
	}
	custom_tooltip = th_monthly_income_negative_tt
	hidden_effect = {
		while = {
			limit = {
				check_variable = {
					which = th_monthly_income
					value = 1
				}
			}
			add_treasury = -1
			subtract_variable = {
				which = th_monthly_income
				value = 1
			}
		}
		multiply_variable = {
			which = th_monthly_income
			value = 100
		}
		while = {
			limit = {
				check_variable = {
					which = th_monthly_income
					value = 1
				}
			}
			add_treasury = -0.01
			subtract_variable = {
				which = th_monthly_income
				value = 1
			}
		}
		clr_global_flag = th_enacted_gensokyan_decree
		set_global_flag = th_enacted_gensokyan_decree
	}
}


##############################################################################################################################
# Magic School Mechanic
##############################################################################################################################
#Following schools are supported:
#conjuration
#evocation
#divination
#transmutation
#enchanting
#abjuration
mim_skill_magic_school = {
	tooltip = {
		if = {
			limit = { is_variable_equal = { which = th_magic_school_$school$ value = 0 } }
			add_country_modifier = { name = th_$school$_level_1 duration = -1 }
		}
		if = {
			limit = { is_variable_equal = { which = th_magic_school_$school$ value = 1 } }
			add_country_modifier = { name = th_$school$_level_2 duration = -1 }
		}
		if = {
			limit = { is_variable_equal = { which = th_magic_school_$school$ value = 2 } }
			add_country_modifier = { name = th_$school$_level_3 duration = -1 }
		}
		if = {
			limit = { is_variable_equal = { which = th_magic_school_$school$ value = 3 } }
			add_country_modifier = { name = th_$school$_level_4 duration = -1 }
		}
	}
	hidden_effect = {
		change_variable = {
			which = th_magic_school_$school$
			value = 1
		}
		change_variable = {
			which = th_magic_school_total_skill_points
			value = 1
		}
		if = {
			limit = { check_variable = { which = th_magic_school_$school$ value = 1 } }
			add_country_modifier = { name = th_$school$_level_1 duration = -1 }
		}
		if = {
			limit = { check_variable = { which = th_magic_school_$school$ value = 2 } }
			add_country_modifier = { name = th_$school$_level_2 duration = -1 }
		}
		if = {
			limit = { check_variable = { which = th_magic_school_$school$ value = 3 } }
			add_country_modifier = { name = th_$school$_level_3 duration = -1 }
		}
		if = {
			limit = { check_variable = { which = th_magic_school_$school$ value = 4 } }
			add_country_modifier = { name = th_$school$_level_4 duration = -1 }
		}
	}
}

mim_add_spell_modifier = {
	if = {
		limit = { is_variable_equal = { which = th_magic_school_$school$ value = 1 } }
		add_country_modifier = { name = $name$ duration = $level_1_duration$ }
	}
	if = {
		limit = { is_variable_equal = { which = th_magic_school_$school$ value = 2 } }
		add_country_modifier = { name = $name$ duration = $level_2_duration$ }
	}
	if = {
		limit = { is_variable_equal = { which = th_magic_school_$school$ value = 3 } }
		add_country_modifier = { name = $name$ duration = $level_3_duration$ }
	}
	if = {
		limit = { is_variable_equal = { which = th_magic_school_$school$ value = 4 } }
		add_country_modifier = { name = $name$ duration = $level_4_duration$ }
	}
	if = {
		limit = { NOT = { check_variable = { which = th_magic_school_$school$ value = 1 } } }
		add_country_modifier = { name = $name$ duration = $duration$ }
	}
}

mim_forget_specialization = {
	remove_country_modifier = th_conjuration_level_1
	remove_country_modifier = th_conjuration_level_2
	remove_country_modifier = th_conjuration_level_3
	remove_country_modifier = th_conjuration_level_4
	remove_country_modifier = th_evocation_level_1
	remove_country_modifier = th_evocation_level_2
	remove_country_modifier = th_evocation_level_3
	remove_country_modifier = th_evocation_level_4
	remove_country_modifier = th_divination_level_1
	remove_country_modifier = th_divination_level_2
	remove_country_modifier = th_divination_level_3
	remove_country_modifier = th_divination_level_4
	remove_country_modifier = th_transmutation_level_1
	remove_country_modifier = th_transmutation_level_2
	remove_country_modifier = th_transmutation_level_3
	remove_country_modifier = th_transmutation_level_4
	remove_country_modifier = th_enchanting_level_1
	remove_country_modifier = th_enchanting_level_2
	remove_country_modifier = th_enchanting_level_3
	remove_country_modifier = th_enchanting_level_4
	remove_country_modifier = th_abjuration_level_1
	remove_country_modifier = th_abjuration_level_2
	remove_country_modifier = th_abjuration_level_3
	remove_country_modifier = th_abjuration_level_4
	remove_country_modifier = th_conjuration_conjured_diplomat
	remove_country_modifier = th_conjuration_conjured_merchant
	remove_country_modifier = th_conjuration_conjured_colonist
	remove_country_modifier = th_conjuration_conjured_missionary
	remove_country_modifier = th_evocation_level_3_infantry_power
	remove_country_modifier = th_evocation_level_3_cavalry_power
	remove_country_modifier = th_evocation_level_3_artillery_power
	remove_country_modifier = th_evocation_level_4_infantry_power
	remove_country_modifier = th_evocation_level_4_cavalry_power
	remove_country_modifier = th_evocation_level_4_artillery_power
	remove_country_modifier = th_enchanting_absolute_shock_resistence
	remove_country_modifier = th_enchanting_absolute_fire_resistence
	set_variable = { which = th_magic_school_conjuration value = 0 }
	set_variable = { which = th_magic_school_evocation value = 0 }
	set_variable = { which = th_magic_school_divination value = 0 }
	set_variable = { which = th_magic_school_transmutation value = 0 }
	set_variable = { which = th_magic_school_enchanting value = 0 }
	set_variable = { which = th_magic_school_abjuration value = 0 }
}

mim_gain_new_skill_reward = {
	if = {
		limit = {
			has_government_attribute = th_has_spell_schools
			OR = {
				mim_has_not_reached_max_level_of_school = { school = conjuration }	
				mim_has_not_reached_max_level_of_school = { school = evocation }	
				mim_has_not_reached_max_level_of_school = { school = divination }	
				mim_has_not_reached_max_level_of_school = { school = transmutation }	
				mim_has_not_reached_max_level_of_school = { school = enchanting }	
				mim_has_not_reached_max_level_of_school = { school = abjuration }
			}
		}
		custom_tooltip = mim_gain_new_skill_reward_tt
		hidden_effect = {
			country_event = {
				id = th_magic_schools.12
			}
		}
	}
	else = {
		add_adm_power = 50
		add_dip_power = 50
		add_mil_power = 50
	}
}


##############################################################################################################################
# Gadgets Mechanic
##############################################################################################################################
#optical_camouflage
#perfect_cucumber_fertilizer
#machine_extending_arm
#sanpei_battleship
#super_scope_3D
#kappa_tanks
#aerial_torpedo
#australian_wildlife
#hisoutensoku
#kappa_shredder
#spice_fuel_engine
#bookkeep_inator
#kiku_ichimonji_compressor
#ooze_flooding
kpp_increase_gadget_usage_counter = {
	hidden_effect = {
		if = {
			limit = {
				NOT = {
					check_variable = {
						which = num_of_$gadget$_used
						value = 25
					}
				}
			}
			change_variable = {
				which = num_of_$gadget$_used
				value = 1
			}
		}
	}
}
kpp_apply_gadget = {
	add_country_modifier = {
		name = th_$gadget$_modifier
		duration = $duration$
	}
}
kpp_unlock_gadget = {
	custom_tooltip = kpp_unlock_$gadget$_tt
	hidden_effect = { set_country_flag = kpp_unlocked_$gadget$_gadget }
}


##############################################################################################################################
# Tenma Mechanic
##############################################################################################################################
th_select_a_tenma_demand = {
	if = {
		limit = {
			has_estate = estate_great_tengu
			NOT = { has_country_flag = estate_great_tengu_$flag$ }
		}
		set_country_flag = estate_great_tengu_$flag$
		[[estate_action]
		$estate_action$ = estate_great_tengu
		]
	}
}


##############################################################################################################################
# Might of Destruction Mechanic
##############################################################################################################################
th_might_of_destruction_gain_effect = {
	if = {
		limit = {
			ROOT = {
				has_government_mechanic = th_might_of_destruction_mechanic
				NOT = { owns = FROM }
			}
		}
		ROOT = {
			add_government_power = {
				mechanic_type = th_might_of_destruction_mechanic
				power_type = th_might_of_destruction
				value = $value$
			}
		}
	}
}

#Yama
th_yama_approving_gensokyan_counter = {
	1 = {
		set_variable = {
			which = th_gensokyan_counter
			value = 0
		}
		set_variable = {
			which = th_approving_gensokyan_counter
			value = 0
		}
	}
	gensokyo_continent = {
		limit = {
			is_capital = yes
		}
		1 = {
			change_variable = {
				which = th_gensokyan_counter
				value = 1
			}
		}
		if = {
			limit = {
				owner = {
					event_target:YamaOfGensokyo = {
						reverse_has_opinion = {
							who = PREV
							value = 50
						}
					}
				}
			}
			1 = {
				change_variable = {
					which = th_approving_gensokyan_counter
					value = 1
				}
			}
		}
	}
}